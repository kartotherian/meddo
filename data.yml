_prefs:
  disabled: []
  inspector: false
  mapid: ''
  rev: ''
  saveCenter: false
name: Meddo
description: Vector tiles for Wikipedia
attribution: 'Data Â© OpenStreetMap contributors'
center:
  - 0
  - 0
  - 4
minzoom: 0
maxzoom: 16
_parts:
  osm2pgsql: &osm2pgsql
    type: postgis
    dbname: "ct"
    srid: 3857
    geometry_field: "way"
    extent: "-20037508,-20037508,20037508,20037508"
Layer:
  - id: water
    geometry: polygon
    properties:
      minzoom: 0
      buffer-size: 4
    Datasource:
      <<: *osm2pgsql
      table: |-
        (SELECT
            way
          FROM water_areas
          WHERE way_area > 0.01*!pixel_width!::real*!pixel_height!::real
        UNION ALL
        SELECT
            geom AS way
          FROM ocean_polygons
        ) AS water
  - id: boundary
    geometry: linestring
    Datasource:
      <<: *osm2pgsql
      table: |-
        (SELECT
            way,
            admin_level,
            disputed
          FROM osmborder_lines
          WHERE NOT (maritime AND NOT disputed)
            AND (admin_level <= 2
            OR admin_level <= 4 AND z(!scale_denominator!) >= 3
            OR admin_level <= 6 AND z(!scale_denominator!) >= 7
            OR admin_level <= 8 AND z(!scale_denominator!) >= 10
            OR z(!scale_denominator!) >= 14)
        ) AS boundary
    properties:
      minzoom: 2
  - id: building
    geometry: polygon
    Datasource:
      <<: *osm2pgsql
      table: |-
        (SELECT
            way
          FROM buildings
          WHERE way_area > 0.01*!pixel_width!::real*!pixel_height!::real
          ORDER BY way_area
        ) AS building
    properties:
      minzoom: 12
  - id: transport
    Datasource:
      <<: *osm2pgsql
      table: |-
        (SELECT
            way,
            class::text,
            ramp,
            oneway,
            brunnel::text,
            layer
          FROM (
            SELECT
                CASE WHEN oneway = 'reverse' THEN ST_Reverse(way) ELSE way END AS way,
                class,
                ramp,
                oneway IN ('true','reverse') AS oneway,
                brunnel,
                layer,
                NULL::real AS way_area
              FROM roads
              WHERE way && !bbox!
                AND (
                  class >= 'motorway'
                  OR class >= 'primary' AND z(!scale_denominator!) >= 7
                  OR class >= 'tertiary' AND z(!scale_denominator!) >= 9
                  OR class >= 'minor' AND z(!scale_denominator!) >= 12
                  OR class >= 'service' AND z(!scale_denominator!) >= 14
                  OR z(!scale_denominator!) >= 14
                )
            UNION ALL
            SELECT
                way,
                class,
                NULL::boolean AS ramp, -- cover ssy
                NULL::boolean AS oneway,
                brunnel,
                layer,
                NULL::real AS way_area
              FROM rail
              WHERE way && !bbox!
            UNION ALL
            SELECT
                way,
                class,
                NULL::boolean AS ramp,
                NULL::boolean AS oneway,
                brunnel,
                layer,
                way_area
              FROM road_areas
              WHERE way && !bbox!
              ) AS t
          ORDER BY layer, ramp DESC, class, way_area DESC NULLS LAST
        ) AS transport
    properties:
      minzoom: 5
  - id: transport_name
    Datasource:
      <<: *osm2pgsql
      table: |-
        (SELECT
            way,
            name,
            NULL::text as ref,
            class::text,
            oneway
          FROM (
            SELECT
                CASE WHEN oneway = 'reverse' THEN ST_Reverse(way) ELSE way END AS way,
                osm_id,
                name,
                class,
                oneway IN ('true','reverse') AS oneway,
                NULL::real AS way_area
              FROM roads
              WHERE way && !bbox!
                AND name IS NOT NULL
                AND (
                  class >= 'motorway'
                  OR class >= 'primary' AND z(!scale_denominator!) >= 7
                  OR class >= 'tertiary' AND z(!scale_denominator!) >= 9
                  OR class >= 'minor' AND z(!scale_denominator!) >= 12
                  OR class >= 'service' AND z(!scale_denominator!) >= 14
                  OR z(!scale_denominator!) >= 14
                )
              ) AS t
          -- This sort needs to sort class reverse to the transport layer, where
          -- high-class roads have to be rendered on top of everything else. Here
          -- high-class roads need their labels placed first.
          ORDER BY class DESC, way_area NULLS FIRST,
            length(name) DESC, name, osm_id
        ) AS transport
    properties:
      minzoom: 5
      buffer-size: 128
  - id: place
    Datasource:
      <<: *osm2pgsql
      table: |-
        (SELECT
            way,
            name,
            rank::text AS class, -- TODO: use a case statement to do this properly
            NULL::bool AS capital,
            NULL::int AS rank
          FROM
            (SELECT
                DISTINCT ON (ST_SnapToGrid(way, !pixel_width!::real*8, !pixel_height!::real*8))
                *
              FROM
                (SELECT
                    way,
                    osm_id,
                    name,
                    class,
                    rank,
                    population,
                    NULL::real AS way_area
                  FROM place_point
                UNION ALL
                SELECT
                    ST_PointOnSurface(way),
                    osm_id,
                    name,
                    class,
                    rank,
                    population,
                    way_area
                  FROM place_polygon
                  WHERE way && !bbox! -- filter pre ST_PointOnSurface
              ) place_all
              WHERE way && !bbox! -- filter points and post ST_PointOnSurface
                AND name IS NOT NULL
                AND (rank >= 'city'
                  OR (z(!scale_denominator!) >= 6 AND rank >='town' AND class = 'settlement')
                  OR (z(!scale_denominator!) >= 8 AND rank >='village' AND class = 'settlement')
                  OR (z(!scale_denominator!) >= 10 AND rank >='hamlet' AND class = 'settlement'))
                   -- todo: add subregions
              ORDER BY
                ST_SnapToGrid(way, !pixel_width!::real*8, !pixel_height!::real*8),
                rank DESC NULLS LAST,
                population DESC NULLS LAST,
                way_area DESC NULLS LAST,
                length(name) DESC,
                name
            ) AS place_gridded
          ORDER BY
            rank DESC NULLS LAST,
            population DESC NULLS LAST,
            way_area DESC NULLS LAST,
            length(name) DESC,
            name
        ) AS place
    properties:
      minzoom: 4
      buffer-size: 128
